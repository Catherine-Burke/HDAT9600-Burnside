---
title: "HDAT9600 Final Assignment"
subtitle: "Submission deadline is 5pm Friday 23 2019 "
author: "insert your team name here"
date: "insert date of completion here"
output: html_document
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)
```

## Instructions

This file (hdat9600_final_assignment.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final assignment. This assignment is assessed and will count for 30% of the total course marks. The assignment comprises two tasks worth 15 marks each. The first task will focus on logistic regression, and the second task will focus on survival analysis. There is no word limit, but a report of about 10 pages in length when printed (except that it will not be printed) is appropriate.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor are happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assignments for you!


## Data for this assignment

The data used for this assignment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assignment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. The original data has been modified and assembled to suit the purpose of this assignment. Full details of the preparatory work can be found in the hdat9600-final-assignment-data-preparation file.

The dataframe consists of 120 variables, which are defined as follows:

####Patient Descriptor Variables
<li> <em>RecordID:</em>   a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patient’s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


####Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


####Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

<li> <em>SAPS-I score</em> [Simplified Acute Physiological Score (<a href="http://www.ncbi.nlm.nih.gov/pubmed/6499483"
target="_blank"><em>Le Gall et al., 1984</em></a>)]</li>
<li> <em>SOFA score</em> [Sequential Organ Failure Assessment (<a href="http://www.ncbi.nlm.nih.gov/pubmed/11594901"
target="_blank"><em>Ferreira et al., 2001</em></a>)]</li>

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

<li><a href="http://en.wikipedia.org/wiki/Human_serum_albumin" target="_blank">
<em>Albumin</em></a> (g/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Alkaline_phosphatase" target="_blank">
<em>ALP</em></a> [Alkaline phosphatase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Alanine_transaminase" target="_blank">
<em>ALT</em></a> [Alanine transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Aspartate_transaminase" target="_blank">
<em>AST</em></a> [Aspartate transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bilirubin" target="_blank">
<em>Bilirubin</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/BUN" target="_blank">
<em>BUN</em></a> [Blood urea nitrogen (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Cholesterol" target="_blank">
<em>Cholesterol</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine"
target="_blank">
<em>Creatinine</em></a> [Serum creatinine (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>DiasABP</em></a> [Invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/FIO2" target="_blank">
<em>FiO2</em></a> [Fractional inspired O<sub>2</sub> (0-1)]</li>
<li><a href="http://en.wikipedia.org/wiki/Glasgow_coma_score" target="_blank">
<em>GCS</em></a> [Glasgow Coma Score (3-15)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_glucose" target="_blank">
<em>Glucose</em></a> [Serum glucose (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics"
target="_blank">
<em>HCO3</em></a> [Serum bicarbonate (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hematocrit" target="_blank">
<em>HCT</em></a> [Hematocrit (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Heart_rate" target="_blank">
<em>HR</em></a> [Heart rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hypokalemia" target="_blank">
<em>K</em></a> [Serum potassium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Lactic_acid" target="_blank">
<em>Lactate</em></a> (mmol/L)</li>
<li><a href="http://en.wikipedia.org/wiki/Magnesium#Biological_role"
target="_blank">
<em>Mg</em></a> [Serum magnesium (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>MAP</em></a> [Invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mechanical_ventilation"
target="_blank">
<em>MechVent</em></a> [Mechanical ventilation respiration (0:false, or 1:true)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_sodium" target="_blank">
<em>Na</em></a> [Serum sodium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>NIDiasABP</em></a> [Non-invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>NIMAP</em></a> [Non-invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>NISysABP</em></a> [Non-invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaCO2</em></a> [partial pressure of arterial CO<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaO2</em></a> [Partial pressure of arterial O<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>pH</em></a> [Arterial pH (0-14)]</li>
<li><a href="http://en.wikipedia.org/wiki/Platelets" target="_blank">
<em>Platelets</em></a> (cells/nL)</li>
<li><a href="http://en.wikipedia.org/wiki/Respiratory_physiology" target="_blank">
<em>RespRate</em></a> [Respiration rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>SaO2</em></a> [O<sub>2</sub> saturation in hemoglobin (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>SysABP</em></a> [Invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Normal_human_body_temperature"
target="_blank">
<em>Temp</em></a> [Temperature (&deg;C)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropI</em></a> [Troponin-I (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropT</em></a> [Troponin-T (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Fluid_balance" target="_blank">
<em>Urine</em></a> [Urine output (mL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology" target="_blank">
<em>WBC</em></a> [White blood cell count (cells/nL)]</li>
<li>
<em>Weight</em> (kg)</li>


##Accessing the Data
The data frame can be loaded with the following code:

```{r}
icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")
```

# Task 1 (15 marks)

In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately explains or predicts the `in_hospital_death` variable as the outcome using a subset of the available predictor variables. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct or complete, but do you best). Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of diagnostic statistics and/or charts and comment on them. You don't need to do an exhaustive exploratory data analysis of all the variables in the data set, but you should examine those variables that you use in your model. Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


### Hints

1. Select an initial subset of explanatory variables that you will use to predict the risk of in-hospital death. Justify your choice.

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate logistic regression models.

4. Fit an appropriate series of multivariable logistic regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them.

7. Write a paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation.



#####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 
```{r - setup for task1}
library(tidyverse)
```
##Jason
##Consideration for variables
_Need to be discerning when selecting variables. Some variables need cleaning (eg 523 values in Bilirubin variables have a min greater then the max). Some variables are missing a lot of data. If we select too many variables with missing data there will be overlap leading to even more loss in our data for analysis. _
#I would be interested to hear people's thoughts on whether we should use the "diff" variables vs running the values as quadratic term "I(x^2)" instead. I suppose the advantage of "diff" is it is supposed to be the most deranged from the mean in either direction whereas the quadratic term would give us a "U" shaped relationship as opposed to a linear one.
##Assessable outcome: "in_hospital_death"
_Demographics: "Weight_diff", "Weight_max", "Weight_min", "Age", "Days", "Gender", "Height", "ICUType", "Length_of_stay"_
_Age and sex are demographics important for identifying confounders. Height is missing a lot of values. Is length of stay a predictor or an outcome? Suggest outcome, remove.  Weight can be bad for overweight and underweight._
##Selected Variables: "Weight_diff", "Age", "Gender", "ICUType "

_CNS: "GCS_diff", "GCS_max", "GCS_min", "Na_diff", "Na_max", "Na_min"_
_Suggest GCS_max (if your best GCS is low, it’s worse than if your worst GCS is low) and Na_diff (high and low sodium are bad)_
##Selected Variables: "GCS_max", "Na_diff"

_CVS: "DiasABP_diff", "DiasABP_max", "DiasABP_min", "HR_diff",  "HR_max", "HR_min", "K_diff", "K_max", "K_min", "Mg_diff", "Mg_max", "Mg_min", "NIDiasABP_diff", "NIDiasABP_max", "NIDiasABP_min", "NIMAP_diff", "NIMAP_max", "NIMAP_min", "NISysABP_diff", "NISysABP_max", "NISysABP_min", "SysABP_diff", "SysABP_max", "SysABP_min", "Temp_diff", "Temp_max", "Temp_min", "TroponinI_diff", "TroponinI_max", "TroponinI_min", "TroponinT_diff", "TroponinT_max", "TroponinT_min", "MAP_diff", "MAP_max",  "MAP_min"_
_The blood pressure variables have a lot of missing data except MAP. Suggest MAP_max as a low MAP isn’t as bad as a high MAP (unless really high). It’s unclear to me if either of the troponins are worth exploring, they’re a marker for AMI but there’s likely only a small proportion of admissions this would be abnormal in. Temp is bad if high or low. Unsure about usefulness of including electrolytes (K, Mg)._
##Selected Variables: "MAP_max", "Temp_diff", "HR_diff"

_PULMONARY: "FiO2_diff", "FiO2_max", "FiO2_min", "PaCO2_diff", "PaCO2_max", "PaCO2_min", "PaO2_diff", "PaO2_max", "PaO2_min", "RespRate_diff", "RespRate_max", "RespRate_min", "SaO2_diff", "SaO2_max", "SaO2_min"_
_PaO2 can be bad if low, usually doesn’t matter if high. PaCO2 can be bad low and high. Respiratory rate bad if low or high. SaO2 just a different measure of arterial oxygenation. FiO2 could be considered for interaction with PaO2 but as the values aren’t linked that would likely be pointless, leave out._
##Selected Variables: "PaO2_max", "PaCO2_diff", "RespRate_diff"

_RENAL: "BUN_diff", "BUN_max", "BUN_min", "Creatinine_diff", "Creatinine_max", "Creatinine_min", "Urine_diff", "Urine_max", "Urine_min"_
_All values are good markers of acute kidney injury or chronic kidney disease which both have a higher than average mortality rate._
##Selected Variables: "Urine_max", "Creatinine_min", "BUN_min"

_LIVER: "Albumin_diff", "Albumin_max", "Albumin_min", "ALP_diff", "ALP_max", "ALP_min", "ALT_diff", "ALT_max", "ALT_min", "AST_diff", "AST_max", "AST_min", "Bilirubin_diff", "Bilirubin_max", "Bilirubin_min", "Cholesterol_diff", "Cholesterol_max", "Cholesterol_min"_
_Low albumin is bad. High bilirubin is bad. ALT and ALT are supportive markers for liver failure but this is adequately covered by bilirubin. Cholesterol is bad if it’s low._
##Selected Variables: "Albumin_max", "Bilirubin_min", "Cholesterol_max"

_METABOLIC/OTHER: "Glucose_diff", "Glucose_max", "Glucose_min", "HCO3_diff", "HCO3_max", "HCO3_min", "Lactate_diff", "Lactate_max", "Lactate_min", "WBC_diff", "WBC_max", "WBC_min", "Platelets_diff", "Platelets_max", "Platelets_min", "pH_diff", "pH_max", "pH_min", "HCT_diff", "HCT_max", "HCT_min"  _
_Glucose bad if low or high. HCO3 bad if it’s low. High lactate is bad. WBC marker for infection in both directions. Low platelets are bad. pH is bad in both directions. It’s unclear to me if HCT is a marker for mortality._
##Selected Variables: "Glucose_diff", "HCO3_max", "Lactate_min", "WBC_diff", "Platelets_min", "pH_diff"

_SCORES: "SAPS1", "SOFA"_
_SAPS1 is an acute physiology score using Age, HR, SBP, Temp, RR, UO, BUN, HCT, WCC, glucose, K, Na, HCO3 and GCS. SOFA score uses GCS, creatinine, bilirubin and MAP. We are already using Age, HR, Temp, RR, UO, BUN, HCT, WCC, glucose, K, Na, HCO3, creatinine, bilirubin, MAP and GCS. SAPS is missing 96 variables, leave out. Keep SOFA._
##Selected Variables: "SOFA"


This code gives proportional views (density histogram, filled barplot) of all variables by outcome of in_hospital_death.
```{r review of all variables}
ICUMort <- icu_patients_df1
require("ggplot2")
library(ggplot2)
for (i in names(ICUMort)){

  if(is.numeric(ICUMort[[i]])){
  
    print(ggplot(ICUMort, aes(ICUMort[[i]])) +
          geom_histogram(aes(y = ..density.., fill = factor(in_hospital_death, labels = c("No","Yes"))), alpha = .3, bins = 30, position = "identity") +
          labs(x=i, fill="Died", title = paste0("Density Plot of ", i,", ", length(na.omit(ICUMort[[i]]))," values available")))

  }else{

    print(ggplot(ICUMort, aes(ICUMort[[i]], fill=factor(in_hospital_death, labels = c("No", "Yes")))) +
          geom_bar(position = "fill") +
          labs(x = i, fill = "Died", title = paste0("Bar Plot of ", i,", ",  length(na.omit(ICUMort[[i]])), " values available")))
  
  }

}
```


##Cath
##Selecting predictor variables for in hostital death

SAPS1 and SOFA seem like obvious choices, as these have been developed as predictors of clinical outcomes (SOFA) and risk of death (SAPS-I).  

Age should also be included, as those who are very young or very old will likely have a higher risk of death.

Include variables from SAPS-I as this has already been verified to correlate with increased risk of death (BUN, GCS, HCO3, HCT, HR, K, Na, RespRate, SysABP, Urine, WBC). Similarly for SOPS (PaO2, Platelets, Bilirubin, Creatinine, GCS).




```{r, EDA}
#added require and lib statement to make sure appropriate packages loaded, I also had a conflict with the select function 
require("dplyr","tidyr","ggplot2")
library(dplyr)
library(tidyr)
library(ggplot2)

#plot distribution of SAPS1 and SOFA by survival
icu_patients_df1 %>% dplyr::select(in_hospital_death, SOFA, SAPS1) %>%
  gather(key = "variable", value = "level", SOFA:SAPS1) %>%
  ggplot(aes(x=level)) + geom_histogram() + 
  facet_grid(in_hospital_death ~ variable, scales = "free")

icu_patients_df1 %>% dplyr::select(in_hospital_death, SOFA, SAPS1) %>%
  gather(key = "variable", value = "level", SOFA:SAPS1) %>%
  ggplot(aes(x=level, fill = factor(in_hospital_death))) +
  geom_histogram(position = "stack", binwidth = 1) +
  facet_grid(. ~ variable, scales = "free")

```


# Task 2 (15 marks)

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately explains or predicts the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a series of models, maybe three or four, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. Aim for between five and ten predictor variables (slightly more or fewer is OK). It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at comment on the possible impact of what your diagnostics show). Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.


### Hints

1. Select an initial subset of explanatory variables that you will use to predict survival. Justify your choice.

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate Cox proportional hazards models.

4. Fit an appropriate series of multivariable Cox proportional hazards models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them. 

7. Write a very brief paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation. 

####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 

```{r data-setup}
library(survival)
```

### Task 2 Part1.a
```{r Taks2_Part1a}
# load the data
icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")
#View(icu_patients_df1)
head(icu_patients_df1)
str(icu_patients_df1)
summary(icu_patients_df1)

```

### Task 2 Part1.b
The categorical variables in the dataset that may be associated with a person’s survival are:
in_hospital_death;
ICUType;
Gender.

The continuous variables in the dataset that may be associated with a person’s survival are:
Length_of_stay;
SAPS1: the risk of death in ICU patients;
SOFA: trends in organ dysfunction;
Survival;
Age;
all 3 summary variables for 36 clinical measures.

### Task 2 Part2
```{r Taks2_Part2.a}
# Basic exploratory data analysis:

cat("Frequency for the categories of in_hospital_death variable")
# use table function to calculate frequency
ihd_table <- table(icu_patients_df1$in_hospital_death)
# use addmargins function to add total to the table
addmargins(ihd_table)
# calculate proportions from the frequency table
# use round function to keep 2 decimal digit
round(prop.table(ihd_table), digits=2)
# As shown in the result: 0(survivor) = 86%; 1(died in-hospital) = 14% 

cat("Frequency for the categories of ICUType variable")
type_table <- table(icu_patients_df1$ICUType)
addmargins(type_table)
round(prop.table(type_table), digits=2)
# As shown in the result: Coronary Care Unit=14%; Surgery Recovery Unit=22%; Medical ICU=38%; Surgical ICU=26%

cat("Frequency for the categories of Gender variable")
Gender_table <- table(icu_patients_df1$Gender)
addmargins(Gender_table)
round(prop.table(Gender_table), digits=2)
# As shown in the result: Female=44%; Male=56%
```


```{r Taks2_Part2.b}
# select only the rows with death as an outcome
hospitaldeath <- icu_patients_df1[icu_patients_df1$in_hospital_death == 1, ]

# Plot the overall Kaplan-Meier survival curve for the hospitaldeath data
hd_fit <- survfit( Surv(Days,Status) ~ 1, data = hospitaldeath) 
summary(hd_fit)

# plotting Kaplan-Meier estimate
plot(hd_fit, main = 'Kaplan-Meier estimate of survival function', xlab = 'Days')

# The Kaplan-Meier plot allows us to see how the survival function changes over time. 
# The dotted lines around the survival curve represents the 95% confidence interval.

# get the mean and median survival times
print(hd_fit, print.rmean = TRUE)
# plot the median survival time
plot(hd_fit, main = 'Kaplan-Meier estimate of survival function', xlab = 'Days')
abline(a = 0.5, b = 0)

# As shown in the table, there were 297 events (deaths) during the follow-up, and the median follow-up time until death is 8 days.

# plotting Nelson-Aalen estimate
plot(hd_fit, fun="cumhaz", main = "Nelson-Aalen estimate of cumulative hazard function", xlab = "Days")
# As shown in the plot, the confidence interval becomes wider after 50 days. 

# plot the Kaplan-Meier survival curves by the categorical variables
par(mfrow=c(2,2))
hd_fitbyihd <- survfit( Surv(Days,Status) ~ in_hospital_death, data = hospitaldeath) 
summary(hd_fitbyihd)
plot(hd_fitbyihd, main = 'Kaplan-Meier estimate of survival function', xlab = 'in-hospital death',col = c("red","blue"))
# 0:survivor; 1:died in-hospital

hd_fitbyGender <- survfit( Surv(Days,Status) ~ Gender, data = hospitaldeath) 
summary(hd_fitbyGender)
plot(hd_fitbyGender, main = 'Kaplan-Meier estimate of survival function', xlab = 'in-hospital death',col = c("red","blue"))

hd_fitbytype <- survfit( Surv(Days,Status) ~ ICUType, data = hospitaldeath) 
summary(hd_fitbytype)
plot(hd_fitbytype, main = 'Kaplan-Meier estimate of survival function', xlab = 'ICU Type',col = c("red","blue","orange","black"))

# calculate log-rank tests for differences in survival experience by the categorical variable
# get the median survival times by in_hospital_death
print(hd_fitbytype) 
# 2-sample log-rank test
hd_fitbytype2 <- coxph( Surv(Days,Status) ~ ICUType, data = hospitaldeath) 
summary(hd_fitbytype2)

print(hd_fitbyGender) 
# 2-sample log-rank test
hd_fitbyGender2 <- coxph( Surv(Days,Status) ~ Gender, data = hospitaldeath) 
summary(hd_fitbyGender2)
```
The non-significant log-rank test of equality of the survival function means that the null hypothesis cannot be rejected, and there is no significant difference between groups. The variables with non-significant log-rank test are ICUType (p-value = 0.4) and Gender (p-value = 0.8).


```{r Taks2_Part2.c}
fitbyall <- coxph( Surv(Days,Status) ~ . , data = icu_patients_df1) 
summary(fitbyall)

# sort p-value 
fitallp <- data.frame(sort(summary(fitbyall)$coef[summary(fitbyall)$coef[,5] <= .05, 5], decreasing = FALSE))
names(fitallp) <- "Pr(>|z|)"
fitallp

# 11 most significant variables: 
# ALP_max, ALP_min, Cholesterol_min, Creatinine_max, Creatinine_min
# MAP_diff, MAP_max, NIMAP_min, pH_min, Urine_diff, Urine_max

```


```{r Taks2_Part2.d}
# Basic exploratory data analysis on variables of choice

# ALP_max, ALP_min, Cholesterol_min, Creatinine_max, Creatinine_min
# MAP_diff, MAP_max, NIMAP_min, pH_min, Urine_diff, Urine_max


summary(icu_patients_df1[,c("ALP_max","ALP_min","Cholesterol_min","Creatinine_max","Creatinine_min",
                            "MAP_diff","MAP_max","NIMAP_min","pH_min","Urine_diff", "Urine_max")])

```

### Task 2 Part3
```{r Taks2_Part3}
# fit Cox PH Model to significant predictor variables
# fit appropriate univariate Cox proportional hazards models

fitbyALPmax <- coxph( Surv(Days,Status) ~ ALP_max, data = icu_patients_df1) 
summary(fitbyALPmax)

fitbyALPmin <- coxph( Surv(Days,Status) ~ ALP_min, data = icu_patients_df1) 
summary(fitbyALPmin)

fitbyCholesterolmin <- coxph( Surv(Days,Status) ~ Cholesterol_min, data = icu_patients_df1) 
summary(fitbyCholesterolmin)

fitbyCreatininemax <- coxph( Surv(Days,Status) ~ Creatinine_max, data = icu_patients_df1) 
summary(fitbyCreatininemax)

fitbyCreatininemin <- coxph( Surv(Days,Status) ~ Creatinine_min, data = icu_patients_df1) 
summary(fitbyCreatininemin)

fitbyMAPdiff <- coxph( Surv(Days,Status) ~ MAP_diff, data = icu_patients_df1) 
summary(fitbyMAPdiff)

fitbyMAPmax <- coxph( Surv(Days,Status) ~ MAP_max, data = icu_patients_df1) 
summary(fitbyMAPmax)

fitbyNIMAPmin <- coxph( Surv(Days,Status) ~ NIMAP_min, data = icu_patients_df1) 
summary(fitbyNIMAPmin)

fitbypHmin <- coxph( Surv(Days,Status) ~ pH_min, data = icu_patients_df1) 
summary(fitbypHmin)

fitbyUrinediff <- coxph( Surv(Days,Status) ~ Urine_diff, data = icu_patients_df1) 
summary(fitbyUrinediff)

fitbyUrinemax <- coxph( Surv(Days,Status) ~ Urine_max, data = icu_patients_df1) 
summary(fitbyUrinemax)

```
The maximum likelihood estimate of the regression coefficient (coef) for ALP_max is 0.0012183 (a positive sign means that the hazard (risk of death) is higher), and thus hazard ratio for ALP_max is exp(0.0012183) = 1.0012190.  
The wald statistic evaluates, whether the beta coefficient of a given variable is statistically significantly different from 0. From the output above, we can conclude that the variable ALP_max have statistically significant coefficients (p-value=0.000399).
The output also provides a 95% confidence interval for ALP_max, 1.001 to 1.002.  
Finally, the output gives p-values for three alternative tests for overall significance of the model: the likelihood-ratio test, Wald test, and score logrank statistics. As shown in the result, the p-value for the overall significance of the model is less than 0.05. 


Non-significant: MAP_max



### Task 2 Part4
```{r Taks2_Part4.a}
# fit multivariable Cox proportional hazards models with significant variables above
cox.mv1 <- coxph(Surv(Days, Status) ~ ALP_max + ALP_min + Cholesterol_min + Creatinine_max + Creatinine_min + MAP_diff  +  MAP_max + NIMAP_min + pH_min + Urine_diff + Urine_max, data = icu_patients_df1)
summary(cox.mv1)

# Not significant in multivariable model
# ALP_max, ALP_min, Creatinine_max, Creatinine_min, MAP_diff, MAP_max

# fit multivariable Cox proportional hazards models with significant univariate Cox proportional hazards models
cox.mv2 <- coxph(Surv(Days, Status) ~ ALP_max + ALP_min + Cholesterol_min + Creatinine_max + Creatinine_min + MAP_diff  + NIMAP_min + pH_min + Urine_diff + Urine_max, data = icu_patients_df1)
summary(cox.mv2)

# Not significant in multivariable model
# ALP_max, ALP_min, Creatinine_max, Creatinine_min

# The p-value (<2e-16) for all three overall tests (likelihood ratio test, Wald test, and score test) are significant, indicating that the model is significant.

cox.mv3 <- coxph(Surv(Days, Status) ~ Cholesterol_min + NIMAP_min + pH_min + Urine_diff + Urine_max, data = icu_patients_df1)
summary(cox.mv3)

print(anova(cox.mv1, cox.mv2))
print(anova(cox.mv2, cox.mv3))

# If the p-value is not sufficiently low (usually greater than 0.05), we should favor the simpler model
# As shown in the result above, the p-value (0.7971) is not significant, cox.mv2 will be chosen.
#  p-value (0.009266) is significant, cox.mv2 will be chosen.


# the AICs for the two models
extractAIC(cox.mv1)
extractAIC(cox.mv2)
extractAIC(cox.mv3)

# Higher (worse) AIC for the cox.mv3 model

```


```{r Taks2_Part4.b}
cox.mv2 <- coxph(Surv(Days, Status) ~ ALP_max + ALP_min + Cholesterol_min + Creatinine_max + Creatinine_min + MAP_diff  + NIMAP_min + pH_min + Urine_diff + Urine_max, data = icu_patients_df1)
summary(cox.mv2)

# testing for proportional hazards assumption using cox.zph()
prop.mv1 <- cox.zph(cox.mv2)
prop.mv1

survminer::ggcoxzph(prop.mv1)








```











### Task 2 Part5
```{r Taks2_Part5}





```










### Task 2 Part6
```{r Taks2_Part6}


```









### Task 2 Part7
```{r Taks2_Part7}


```










## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works, and then submit via the drop box in Openlearning.

## Submit your assignment

When you have finished, and are satisfied with your assignment solutions, and this file knits without errors and the output looks the way you want, then you should submit via the drop box in Openlearning.

### Problems?

If you encounter problems with any part of the process described above, please contact the course instructor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assignment is due.


### Additional Information

Each task attracts the indicated number of marks (out of a total of 30 marks for the assignment). The instructions are deliberately open-ended and less prescriptive than the individual assignments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks and gain full marks, you only need to replicate or repeat the steps covered in the course - if you do most or all of the things described in the revalant chapters of the HDAT9600 course, full marks wil be awarded. 

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course instructor.
