---
title: "HDAT9600 Final Assignment"
author: "Team Burnside"
date: "Friday 23 August 2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
options(width=120)
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)

#make sure appropriate libraries are installed
libs <- c("tidyverse", "ggplot2", "corrplot", "ResourceSelection", "DescTools", "pROC", "caret", "survival", "survminer", "rankhazard", "eha", "gridExtra")
missing <- !libs %in% installed.packages()
if (any(missing)) {
  install.packages(libs[missing],repos="https://cloud.r-project.org", dependencies = TRUE)
}
```

## Instructions

This file (hdat9600_final_assignment.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final assignment. This assignment is assessed and will count for 30% of the total course marks. The assignment comprises two tasks worth 15 marks each. The first task will focus on logistic regression, and the second task will focus on survival analysis. There is no word limit, but a report of about 10 pages in length when printed (except that it will not be printed) is appropriate.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor are happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assignments for you!


## Data for this assignment

The data used for this assignment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assignment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. The original data has been modified and assembled to suit the purpose of this assignment. Full details of the preparatory work can be found in the hdat9600-final-assignment-data-preparation file.

The dataframe consists of 120 variables, which are defined as follows:

####Patient Descriptor Variables
<li> <em>RecordID:</em>   a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patient’s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


####Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


####Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

<li> <em>SAPS-I score</em> [Simplified Acute Physiological Score (<a href="http://www.ncbi.nlm.nih.gov/pubmed/6499483"
target="_blank"><em>Le Gall et al., 1984</em></a>)]</li>
<li> <em>SOFA score</em> [Sequential Organ Failure Assessment (<a href="http://www.ncbi.nlm.nih.gov/pubmed/11594901"
target="_blank"><em>Ferreira et al., 2001</em></a>)]</li>

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

<li><a href="http://en.wikipedia.org/wiki/Human_serum_albumin" target="_blank">
<em>Albumin</em></a> (g/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Alkaline_phosphatase" target="_blank">
<em>ALP</em></a> [Alkaline phosphatase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Alanine_transaminase" target="_blank">
<em>ALT</em></a> [Alanine transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Aspartate_transaminase" target="_blank">
<em>AST</em></a> [Aspartate transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bilirubin" target="_blank">
<em>Bilirubin</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/BUN" target="_blank">
<em>BUN</em></a> [Blood urea nitrogen (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Cholesterol" target="_blank">
<em>Cholesterol</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine"
target="_blank">
<em>Creatinine</em></a> [Serum creatinine (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>DiasABP</em></a> [Invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/FIO2" target="_blank">
<em>FiO2</em></a> [Fractional inspired O<sub>2</sub> (0-1)]</li>
<li><a href="http://en.wikipedia.org/wiki/Glasgow_coma_score" target="_blank">
<em>GCS</em></a> [Glasgow Coma Score (3-15)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_glucose" target="_blank">
<em>Glucose</em></a> [Serum glucose (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics"
target="_blank">
<em>HCO3</em></a> [Serum bicarbonate (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hematocrit" target="_blank">
<em>HCT</em></a> [Hematocrit (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Heart_rate" target="_blank">
<em>HR</em></a> [Heart rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hypokalemia" target="_blank">
<em>K</em></a> [Serum potassium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Lactic_acid" target="_blank">
<em>Lactate</em></a> (mmol/L)</li>
<li><a href="http://en.wikipedia.org/wiki/Magnesium#Biological_role"
target="_blank">
<em>Mg</em></a> [Serum magnesium (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>MAP</em></a> [Invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mechanical_ventilation"
target="_blank">
<em>MechVent</em></a> [Mechanical ventilation respiration (0:false, or 1:true)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_sodium" target="_blank">
<em>Na</em></a> [Serum sodium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>NIDiasABP</em></a> [Non-invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>NIMAP</em></a> [Non-invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>NISysABP</em></a> [Non-invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaCO2</em></a> [partial pressure of arterial CO<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaO2</em></a> [Partial pressure of arterial O<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>pH</em></a> [Arterial pH (0-14)]</li>
<li><a href="http://en.wikipedia.org/wiki/Platelets" target="_blank">
<em>Platelets</em></a> (cells/nL)</li>
<li><a href="http://en.wikipedia.org/wiki/Respiratory_physiology" target="_blank">
<em>RespRate</em></a> [Respiration rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>SaO2</em></a> [O<sub>2</sub> saturation in hemoglobin (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>SysABP</em></a> [Invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Normal_human_body_temperature"
target="_blank">
<em>Temp</em></a> [Temperature (&deg;C)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropI</em></a> [Troponin-I (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropT</em></a> [Troponin-T (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Fluid_balance" target="_blank">
<em>Urine</em></a> [Urine output (mL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology" target="_blank">
<em>WBC</em></a> [White blood cell count (cells/nL)]</li>
<li>
<em>Weight</em> (kg)</li>


##Accessing the Data
The data frame can be loaded with the following code:

```{r}
icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")
```

# Task 1 (15 marks)

In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately explains or predicts the `in_hospital_death` variable as the outcome using a subset of the available predictor variables. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct or complete, but do you best). Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of diagnostic statistics and/or charts and comment on them. You don't need to do an exhaustive exploratory data analysis of all the variables in the data set, but you should examine those variables that you use in your model. Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


### Hints

1. Select an initial subset of explanatory variables that you will use to predict the risk of in-hospital death. Justify your choice.

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate logistic regression models.

4. Fit an appropriate series of multivariable logistic regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them.

7. Write a paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation.



#####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 
```{r, setup for task1}
library(tidyverse)
library(ggplot2)
```

## Consideration for variables
We only need to include 5-10ish variables. This is requires a logical approach to culling. The first step is to remove any variables that do not have a full set of data (eg 2061 records). The rationale for this is that if you include incomplete variables then drop an incomplete variable you may not be able to adequately compare the current model to the previous one.  
  
```{r data cleaning and checking}

#check which variables have incomplete data
nalist <- sapply(icu_patients_df1, function(x) sum(is.na(x)))
nalist[nalist!=0]

#check data for internal consistency (max vs min values).  Prints the number of instances where the max value is smaller than the min value.
for (i in names(icu_patients_df1)){
  if (substr(i, nchar(i)-2, nchar(i)) == "max"){
  j <- paste0(substr(i, 1, nchar(i)-4 ),"_min")
  print(c(substr(i, 1, nchar(i)-4 ), length(as.matrix(icu_patients_df1[na.omit(icu_patients_df1[,i])<na.omit(icu_patients_df1[,j]),c(i,j)]))/2))
  }
}

#ensure all max and min values are in the right columns
#function to swap values that are inconsistent with allocation
maxval <- function(df, Max, Min){
  df[na.omit(df[,Max])<na.omit(df[,Min]),c(Min,Max)] <- unname(df[na.omit(df[,Max])<na.omit(df[,Min]),c(Max,Min)])
  df
}

#loop checks for "max" variables then compares to the corresponding "min" value and swaps values where necessary
for (i in names(icu_patients_df1)){
  if (substr(i, nchar(i)-2, nchar(i)) == "max"){
  j <- paste0(substr(i, 1, nchar(i)-4 ),"_min")
  icu_patients_df1 <- maxval(icu_patients_df1, i, j)
  }
}

#reassess internal consistency (max vs min values)
for (i in names(icu_patients_df1)){
  if (substr(i, nchar(i)-2, nchar(i)) == "max"){
  j <- paste0(substr(i, 1, nchar(i)-4 ),"_min")
  print(c(substr(i, 1, nchar(i)-4 ), length(as.matrix(icu_patients_df1[na.omit(icu_patients_df1[,i])<na.omit(icu_patients_df1[,j],c(i,j))]))/2))
  }
}

#check score variable distributions
table(icu_patients_df1$SOFA)
table(icu_patients_df1$SAPS1)

#65 scores of -1 for SOFA - investigate (check for consistency with scoring against GCS, MAP, Creatinine/Urine, PaO2/FiO2, Bilirubin and Platelets)
icu_patients_df1[icu_patients_df1$SOFA==0 & icu_patients_df1$MAP_min<70,c("SOFA", "PaO2_min", "FiO2_max", "Bilirubin_max", "GCS_min", "Creatinine_max", "Urine_max", "Platelets_min", "MAP_min")]
#noted variation in score relative to variables. Eg, 20/52 SOFA scores of 0 appear wrong based on MAP. Difficult and time consuming to determine accuracy of other scores - assume inaccurate, leave out. Use SAPS1 instead
#remove SOFA score

#remove incomplete variables to maintain data integrity but keeps SAPS1 as a predictor and not too many values missing (96/2061)
ICUMort <- icu_patients_df1[,complete.cases(t(icu_patients_df1))]
ICUMort <- cbind(ICUMort, SAPS1=icu_patients_df1$SAPS1)
ICUMort <- within(ICUMort, rm(SOFA, RecordID, Length_of_stay, Days, Status))

#SAPS1 includes Age, HR, SBP, Temp, RR, urine, BUN, HCT, WBC, glucose, potassium, sodium, HCO3, GCS using most deranged value in first 24 hours.

summ.all.mod <- summary(glm(in_hospital_death ~ ., data = ICUMort, family = binomial))
summ.all.mod$coefficients[summ.all.mod$coefficients[,4]<0.1,]
#Age, GCS_max,SAPS1,MAP_max,HR_min,MAP_diff,Platelets_diff,ALP_max,PaO2_max,Urine_max,BUN_min,WBC_max,ALP_diff,Albumin_diff,HCT_max,ALT_diff,ICUType,Urine_diff,Lactate_diff all statistically significant at <0.1
#ICUType appears to play a role, logically the patients between units will be very different, investigate if different variables affect different groups more

#create vector of statistically significant variables - removed matching variable with lower significance
stat.list <- c("Age", "GCS_max","SAPS1","MAP_max","HR_min","Platelets_diff","ALP_max","PaO2_max","Urine_max","BUN_min","WBC_max","Albumin_diff","HCT_max","ALT_diff","ICUType","Lactate_diff")

#create model variable list without ICUType
unit.mod.list <- paste0(c("in_hospital_death ~", stat.list[stat.list != "ICUType"]), collapse = " + ")

#review analysis of ICUType specific models, create data frames
ICUMort.CCU <- ICUMort[ICUMort$ICUType=="Coronary Care Unit",]
ICUMort.CCU <- within(ICUMort.CCU, rm(ICUType))
ICUMort.MICU <- ICUMort[ICUMort$ICUType=="Medical ICU",]
ICUMort.MICU <- within(ICUMort.MICU, rm(ICUType))
ICUMort.SICU <- ICUMort[ICUMort$ICUType=="Surgical ICU",]
ICUMort.SICU <- within(ICUMort.SICU, rm(ICUType))
ICUMort.CSRU <- ICUMort[ICUMort$ICUType=="Cardiac Surgery Recovery Unit",]
ICUMort.CSRU <- within(ICUMort.CSRU, rm(ICUType))

print("CCU")
summ.all.mod <- summary(glm(unit.mod.list, data = ICUMort.CCU, family = binomial))
summ.all.mod$coefficients[summ.all.mod$coefficients[,4]<0.1,]
print("MICU")
summ.all.mod <- summary(glm(unit.mod.list, data = ICUMort.MICU, family = binomial))
summ.all.mod$coefficients[summ.all.mod$coefficients[,4]<0.1,]
print("SICU")
summ.all.mod <- summary(glm(unit.mod.list, data = ICUMort.SICU, family = binomial))
summ.all.mod$coefficients[summ.all.mod$coefficients[,4]<0.1,]
print("CSRU")
summ.all.mod <- summary(glm(unit.mod.list, data = ICUMort.CSRU, family = binomial))
summ.all.mod$coefficients[summ.all.mod$coefficients[,4]<0.1,]




```
  
# Statistically significant Variables left after incomplete and other outcome related variables removed. Ordered by p-value.
_"Age", "GCS_max","SAPS1","MAP_max","HR_min","MAP_diff","Platelets_diff","ALP_max","PaO2_max","Urine_max","BUN_min","WBC_max","ALP_diff","Albumin_diff","HCT_max","ALT_diff","ICUType","Urine_diff","Lactate_diff")_

## Assessable outcome: "in_hospital_death"  
  
_Demographics: "Age", "ICUType", "Gender"_
_Age and sex are demographics important for identifying confounders. ICUType identifies different patient cohorts Keep all._
## Selected Variables: "Age", "Gender", "ICUType" 
Total number of variables = 3

_Scores: "SAPS1"_
_SAPS1 includes Age, HR, SBP, Temp, RR, urine, BUN, HCT, WBC, glucose, potassium, sodium, HCO3, GCS using most deranged value in first 24 hours._
## Selected Variables: "SAPS1"
Total number of variables = 4

_CNS: "GCS_max"_
_Sodium and GCS included in SAPS1. Review both in context of other variables._
## Selected Variables: "GCS_max"
Total number of variables = 5

_Cardiovascular: "MAP_max","HR_min","MAP_diff"_
_Logically it makes sense to keep MAP_max over MAP_diff. Lower BP associated with poorer outcomes. HR_min also very statistically significant. Keep both._
## Selected Variables: "MAP_max", "HR_min"
Total number of variables = 7

_Respiratory: "PaO2_max"_
_PaO2_max only variable for respiratory disfunction, keep._
## Selected Variables: "PaO2_max"
Total number of variables = 8

_Renal: "Urine_max","BUN_min","Urine_diff"_
_All values are good markers of acute kidney injury or chronic kidney disease which both have a higher than average mortality rate. Preference Urine_max over Urine_diff._
## Selected Variables: "Urine_max","BUN_min"
Total number of variables = 10

_Liver: "ALP_max","ALP_diff","Albumin_diff","ALT_diff"_
_ALP_max only value significant <0.05._
## Selected Variables: "ALP_max"
Total number of variables = 11

_Metabolic/Other: "Platelets_diff","WBC_max","HCT_max","Lactate_diff"_
_Platelets_diff and HCT_max not significant in any ICU type models, Platelets very significant in full model though. Keep WBS_max, Platelets_diff and Lactate_diff._
## Selected Variables: "WBC_max","Lactate_diff", "Platelets_diff"
Total number of variables = 14

# 14 Variables selected with intention to drop ~5+.

```{r review of selected variables}
#create dataframe with selected variables
#create list of selected variables
var.list <- c("Age", "GCS_max","SAPS1","MAP_max","HR_min","Platelets_diff","ALP_max","PaO2_max","Urine_max","BUN_min","WBC_max","ICUType","Lactate_diff", "Gender", "in_hospital_death")

#create empty list for variables to go into
test.list <- NULL

#fill empty list with all possible variables for data frame
for (i in names(ICUMort)){
  for (j in var.list){
    if (substr(i, 1, nchar(j)) == j){
      test.list <- c(test.list, i) 
      }
    }
  }

#check list
test.list

#update to testing data frame
ICUMort.t <- ICUMort[,test.list]
#remove na data from data frame for consistent analysis
ICUMort.t <- ICUMort.t[complete.cases(ICUMort.t),]

#put all variables in a model to determine statistical significance
testing_mod <- glm(in_hospital_death ~ ., data=ICUMort.t, family="binomial")
(sumtest <- summary(testing_mod))

#print statisically significant values (at 0.1) to assess
coef.df <- as.data.frame(sumtest$coefficients)
round(as.matrix(coef.df[coef.df$`Pr(>|z|)`<0.1,]),4)

#statisically significant values -> Age, Bilirubin_diff, BUN_min, GCS_max, ICUType, MAP_max, Na_max, PaO2_max, Platelets_diff, RespRate_min, SAPS1
#Gender not statistically significant alone but likely to have interactions.

#final data frame for analysis - leaving gender in
ICUMort.f <- icu_patients_df1[,c("Age", "GCS_max", "SAPS1", "HR_min", "ALP_max", "PaO2_max", "Urine_max", "BUN_min", "WBC_max", "ICUType", "Lactate_diff", "Gender", "in_hospital_death")]
ICUMort.f <- ICUMort.f[complete.cases(ICUMort.f),]

```

## EDA
```{r eda}
summary(ICUMort.f)
str(ICUMort.f)

#density plots for reviewing variables based on outcome
#Create empty list to store plots
plot_list <- list()
for (i in names(ICUMort.f)[1:12]){
  
  if(is.numeric(ICUMort.f[[i]])){
  
    plot_list[[i]] <- ggplot(ICUMort.f, aes_string(i)) +
          geom_histogram(aes(y = ..density.., fill = factor(in_hospital_death, labels = c("No","Yes"))), alpha = .3, bins = 60, position = "identity") +
          labs(x=i, fill="Died", title = paste0("Density Plot of ", i)) + 
      theme(text = element_text(size=6)) + 
      theme(legend.position = "none")

    }else{

    plot_list[[i]] <- ggplot(ICUMort.f, aes_string(i)) +
          geom_bar(position = "fill", aes(fill=factor(in_hospital_death, labels = c("No", "Yes")))) +
          labs(x = i, fill = "Died", title = paste0("Bar Plot of ", i)) +
      theme(text = element_text(size=6)) +
    theme(legend.position = "none")
 
  }
}
library(gridExtra)

#create ggplot for legend formatting
temp_legend <- ggplot(ICUMort.f, aes(ICUType)) +
          geom_bar(position = "fill", aes(fill=factor(in_hospital_death, labels = c("No", "Yes")))) +
          theme(legend.direction = "horizontal", legend.position = "bottom") + labs(fill = "Died") 

# create get_legend function
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

# Extract legend using get_legend function
legend <- get_legend(temp_legend)

#plot grid of output
n <- length(plot_list)
nCol <- 4
do.call("grid.arrange", c(grobs=c(plot_list,list(legend)), ncol=nCol))

#review relationships with gender
#Create empty list for plotting
plot_list2 <- list()
for (i in names(ICUMort.f)[1:12]){
  if(is.numeric(ICUMort.f[[i]])){
    ybl <- boxplot.stats(ICUMort.f[[i]])$stats[c(1, 5)]
    ybl <- ybl * c(.75,1.25)
    plot_list2[[i]] <- ggplot(ICUMort.f, aes_string(x = "Gender", y=i)) + 
            geom_boxplot(outlier.colour = NA,
                         aes(fill = factor(in_hospital_death, 
                                           labels = c("No","Yes")))) + 
            coord_cartesian(ylim = ybl) +
            labs(y=i, fill="Died", 
                 title = paste0("Boxplot of ", i)) + theme(text = element_text(size=6)) +
      theme(legend.position = "none")
      
          }
}


do.call("grid.arrange", c(grobs=c(plot_list2,list(legend)), ncol=nCol))
#possible interactions: ALP_max:Gender, BUN_min:Gender, Lactate_diff:Gender, Age:Gender

#review relationships with ICUtype
plot_list3 <- list()
for (i in names(ICUMort.f[1:12])){
  if(is.numeric(ICUMort.f[[i]])){
    ybl <- boxplot.stats(ICUMort.f[[i]])$stats[c(1, 5)]
    ybl <- ybl * c(.75,1.25)
    plot_list3[[i]] <- 
      ggplot(ICUMort.f, aes_string(x = "ICUType", y = i)) +
      geom_boxplot(outlier.colour = NA, aes(fill = factor(in_hospital_death, labels = c("No","Yes")))) + 
      coord_cartesian(ylim = ybl) +
      labs(y=i, fill="Died", 
           title = paste0("Boxplot of ", i)) + 
      theme(text = element_text(size = 6)) + theme(legend.position = "none")
      
          }
}
do.call("grid.arrange", c(grobs=c(plot_list3,list(legend)), ncol = nCol))
#possible interactions: all variables appear to have some interaction with ICU type except WCC and lactate. Explored further later.


#correlation plot to  explore relationships
library(corrplot)
ICUMort.cor <- cor(ICUMort.f[,sapply(ICUMort.f, is.numeric)])
corrplot(ICUMort.cor,  method = "circle", type = "upper")

#no noted correlation beyond those expected with SAPS1

#check each variable against eachother seperated by outcome
# for(i in 2:(length(ICUMort.f)-1)){
#     colnam <- names(ICUMort.f[i])
#     if(is.numeric(ICUMort.f[[i]])==TRUE){
#         for(j in (i+1):length(ICUMort.f)){
#             colnam2 <- names(ICUMort.f[j])
#             if(is.numeric(ICUMort.f[[j]])==TRUE){
#             gp <- ggplot(ICUMort.f, aes(ICUMort.f[[i]],ICUMort.f[[j]], colour = factor(in_hospital_death, labels = c("No","Yes")))) + 
#                      geom_point() +
#                 labs(title=paste("Plot of",colnam,"vs",colnam2),x=colnam,y=colnam2,colour="Died") + geom_smooth(method="lm")
#             #abline(lm(ICUMort.f[[j]]~ICUMort.f[[i]]),col="red")
#             print(gp)
#                 }
#             }
#         }
# }

#only BUN_min:Urine_max, HR_min:GCS_max noted as possibilities
intplot1 <- ggplot(ICUMort.f, aes(BUN_min,Urine_max, colour = factor(in_hospital_death, labels = c("No","Yes")))) + 
                geom_point() + geom_smooth(method="lm") + theme(legend.position = "none") +
                labs(title=paste("Plot of BUN_min vs Urine_max"),colour="Died")
                
intplot2 <- ggplot(ICUMort.f, aes(HR_min,GCS_max, colour = factor(in_hospital_death, labels = c("No","Yes")))) + 
                geom_point() + geom_smooth(method="lm") + theme(legend.position = "none") +
                labs(title=paste("Plot of HR_min vs GCS_max"),colour="Died")

grid.arrange(intplot1, intplot2, ncol=1, bottom = legend)
```

## Fit Univariate Models

```{r, task 1 univariate models, include = FALSE}

#Should start with univariate models for each of the variables we included.
#Create vector of variables
var_selection <- c("Age", "GCS_max", "SAPS1", "HR_min", "ALP_max", "PaO2_max", "Urine_max", "BUN_min", "WBC_max", "ICUType", "Lactate_diff", "Gender", "in_hospital_death")
#Create a list of univariate models for each of the variables selected
formulas<- paste('in_hospital_death ~', var_selection[1:12])
unimod_list <- lapply(formulas, glm, family = binomial(), data = ICUMort.f)
#Summary of all models
unimod_summ <- lapply(unimod_list, summary)
lapply(unimod_summ, function(x) {round(x$coefficients, 6)})

#check possible quadric interactions on HR_min and WBC_max
summary(glm(in_hospital_death ~ I(HR_min^2), family = binomial(), data = ICUMort.f))
summary(glm(in_hospital_death ~ I(WBC_max^2), family = binomial(), data = ICUMort.f))
#improves HR_min, not WBC_max, neither enough to warrant use

#All variables except WBC_max and Gender are significant in univariate models
#Extract exp of coefficients - odds for each variable
unimod_odds <- lapply(unimod_list, function(x) {exp(coef(x))})
unimod_odds

#Check interactions from EDA
var_int_selection <- c("BUN_min:Urine_max", "I(HR_min^2):GCS_max", "HR_min:GCS_max", "ALP_max:Gender", "BUN_min:Gender", "Lactate_diff:Gender", "Age:Gender", "Age:ICUType", "GCS_max:ICUType", "SAPS1:ICUType", "I(HR_min^2):ICUType", "HR_min:ICUType", "ALP_max:ICUType", "PaO2_max:ICUType", "Urine_max:ICUType", "BUN_min:ICUType", "Gender:ICUType")
formulas_int<- paste('in_hospital_death ~', var_int_selection)
unimod_int_list <- lapply(formulas_int, glm, family = binomial(), data = ICUMort.f)
unimod_int_summ <- lapply(unimod_int_list, summary)
lapply(unimod_int_summ, function(x) {round(x$coefficients, 6)})


#Only BUN_min:Urine_max not significant, keep qudratic term for HR interaction with ICUType. Keep original with GCS_max as not improved.

```

Most variables which were significant in the univariate models appear to individually have a small effect on the risk of death.  Variables that increase the risk of death with a unit increase of the variable include SAPS1, Age, BUN_min, HR_min, ALP_max and WBC_max, with all increasing risk by between 0.01% - 13%. Variable that decrease risk were GCS_max (~16%), Urine_max (0.02%) and PaO2_max (0.002%) as per below.

{r unimod_odds}

There are also many significant interactions between the continuous and categorical variables.

## Fit Mutivariable Models

```{r, task 1 multivariate models, include = FALSE}
#Only include statisically significant variables from above. cut off 0.05.
full_mod<-glm(in_hospital_death ~ SAPS1 + Age + BUN_min + GCS_max + ALP_max + ICUType + PaO2_max + Urine_max +
                Lactate_diff, family = binomial(), data = ICUMort.f)
summary(full_mod)
#check statistically significant values
#create statistically significant model
sig_full_mod<-glm(in_hospital_death ~ Age + GCS_max + SAPS1 + ALP_max + PaO2_max + Urine_max + BUN_min +
                    ICUType + Lactate_diff, family = binomial(), data = ICUMort.f)
summary(sig_full_mod)

#compare full with statistically significant for anova and AIC
anova(full_mod, sig_full_mod, test = "Chisq")
full_mod$aic
sig_full_mod$aic
#test not significant, AIC lower for sig model, we can accept the simpler model

#check full models against stepwise removal of variables
red_full_mod <- step(full_mod, trace = 0)
anova(red_full_mod, sig_full_mod, test = "Chisq")
red_full_mod$aic
sig_full_mod$aic
#model unable to be improved
f.mod1 <- sig_full_mod ##SHould this be red_full_mod??

#Statistically significant interactions from individual models above
int_mod<-glm(in_hospital_death ~  HR_min:GCS_max + ALP_max:Gender + BUN_min:Gender + Lactate_diff:Gender + Age:Gender + 
               Age:ICUType + GCS_max:ICUType + SAPS1:ICUType + I(HR_min^2):ICUType + ALP_max:ICUType + PaO2_max:ICUType +
               Urine_max:ICUType + BUN_min:ICUType + Gender:ICUType, family = binomial(), data = ICUMort.f)
summary(int_mod)
#check statistically significant values
coef.df <- as.data.frame(summary(int_mod)$coefficients)
as.matrix(coef.df[coef.df$`Pr(>|z|)`<0.05,])
#Age:BUN_min, GCS_max:Gender, SAPS1:ICUType, Bilirubin_diff:ICUType, BUN_min:ICUType, GCS_max:ICUType, PaO2_max:ICUType
#create statistically significant model
sig_int_mod<-glm(in_hospital_death ~ HR_min:GCS_max + BUN_min:Gender + Lactate_diff:Gender +
               Age:ICUType + GCS_max:ICUType + SAPS1:ICUType + I(HR_min^2):ICUType + Gender:ICUType, family = binomial(), data = ICUMort.f)
summary(sig_int_mod)

#compare full with statistically significant for anova and AIC
anova(int_mod, sig_int_mod, test = "Chisq")
int_mod$aic
sig_int_mod$aic
#test statistically significant, AIC lower for int model, reject null hypothesis and keep original model

#check full models against stepwise removal of variables
red_int_mod <- step(int_mod, trace = 0)
anova(red_int_mod, int_mod, test = "Chisq")
red_int_mod$aic
int_mod$aic
#test not significant, AIC better for reduced model, we can accept the simpler model - red_int_mod
f.mod2 <- red_int_mod

#Full model with interactions
full_int_mod <-glm(in_hospital_death ~ SAPS1 + Age + BUN_min + GCS_max + ALP_max + ICUType + PaO2_max + Urine_max +
                Lactate_diff + HR_min:GCS_max + ALP_max:Gender + BUN_min:Gender + Lactate_diff:Gender + Age:Gender + 
               Age:ICUType + GCS_max:ICUType + SAPS1:ICUType + I(HR_min^2):ICUType + ALP_max:ICUType + PaO2_max:ICUType +
               Urine_max:ICUType + BUN_min:ICUType + Gender:ICUType, family = binomial(), data = ICUMort.f)
summary(full_int_mod)
#check statistically significant values
# coef.df <- as.data.frame(summary(full_int_mod)$coefficients)
# as.matrix(coef.df[coef.df$`Pr(>|z|)`<0.05,])
#pH_diff, BUN_min, Na_max, GCS_max, Age, ICUType, Gender, Age:Gender, PaO2_max:ICUType, GCS_max:ICUType

#create statistically significant model at 0.1
sig_full_int_mod<-glm(in_hospital_death ~ SAPS1 + BUN_min + GCS_max + Lactate_diff + GCS_max:ICUType + PaO2_max +
                        Gender:ICUType + SAPS1:ICUType, family = binomial(), data = ICUMort.f)
summary(sig_full_int_mod)

#compare full with statistically significant for anova and AIC
anova(full_int_mod, sig_full_int_mod, test = "Chisq")
full_int_mod$aic
sig_full_int_mod$aic
#test statistically significant, AIC lower for full int model, reject null hypothesis and keep original model

#check full models against stepwise removal of variables
red_full_int_mod <- step(full_int_mod, trace = 0)
anova(red_full_int_mod, full_int_mod, test = "Chisq")
red_full_int_mod$aic
full_int_mod$aic
#test not significant, AIC better for reduced model, we can accept the simpler model - red_full_int_mod
f.mod3 <- red_full_int_mod

#Compare chosen models to a null model
null_mod <- glm(in_hospital_death ~ 1, family = binomial, data = ICUMort.f)
#anova(sig_full_mod, null_mod, test = "Chisq")
anova(f.mod1, null_mod, test = "Chisq")
anova(f.mod2, null_mod, test = "Chisq")
anova(f.mod3, null_mod, test = "Chisq")
#All tests statistically significant - Reject null hypothesis of no relationship between predictors and outcome for all models

#compare chosen models
#model 2 is preferable to model 1 based on AIC
anova(f.mod1, f.mod3, test = "Chisq")
f.mod1$aic
f.mod3$aic
#model 3 preferable to model 1 based on AIC
anova(f.mod2, f.mod3, test = "Chisq")
f.mod2$aic
f.mod3$aic
#all tests statistically significant, can not reject null hypothesis, AIC improved on reduced models, 
#unable to compare interaction models due to not enough degrees of freedom, 
#p-value more significant for reduced full interaction model (fmod.3) and AIC lower that both other models

```

## Model Selection  
Three models have been selected for further assessment. Each model has been assessed for best fit prior to selection. `f.mod1` is a multivariable model, `f.mod2` is a model with only interaction terms and `f.mod3` is a model with the multivariable and interation terms combined. 

```{r, Task1, goodness of fit}

#Calculate the Hosmer-Lemeshow statistic
#linear predictors
library(ResourceSelection)
#Vector of predicted probabilities
pred_mod1 <- predict(f.mod1, type = "response")
(hl_mod1 <- hoslem.test(f.mod1$y, pred_mod1, g=75))
#No indication of a lack of fit as p > 0.05.

pred_mod2 <- predict(f.mod2, type = "response")
(hl_mod2 <- hoslem.test(f.mod2$y, pred_mod2, g=75))
#No indication of a lack of fit as p > 0.05.

pred_mod3 <- predict(f.mod3, type = "response")
(hl_mod3 <- hoslem.test(f.mod3$y, pred_mod3, g=75))
#No indication of a lack of fit as p > 0.05.

pred_null <- predict(null_mod, type = "response")


#difficulty assessing goodness of fit, check p-value over bins size 11:210 bins
cn <- c("bins","f.mod1", "f.mod2", "f.mod3")
mt <- matrix(nrow=200,ncol=4, dimnames = list(NULL, cn))
for (i in 11:210){
    j<- i-10
    w <- hoslem.test(f.mod1$y, pred_mod1, g=i)
    x <- hoslem.test(f.mod2$y, pred_mod2, g=i)
    y <- hoslem.test(f.mod3$y, pred_mod3, g=i)
#    z <- hoslem.test(null_mod$y, pred_null, g=i)
      mt[j,1] <- i
      mt[j,2] <- w$p.value
      mt[j,3] <- x$p.value
      mt[j,4] <- y$p.value
#      mt[j,5] <- z$p.value
}
mt <- as.data.frame(mt)
#plot goodness of fit over 200 bins
plot(mt$bins,mt$f.mod1, type="l", ylim=c(0,1), xlab="Number of bins", ylab="p-value", main="Hosmer-Lemeshow Goodness of Fit Test", col="blue",lwd=2)
abline(h=0.05, col="red")
abline(v=75, col="red")
lines(mt$bins,mt$f.mod2, col="dark green", lty = 2,lwd=2)
lines(mt$bins,mt$f.mod3, col="black", lty = 1,lwd=2)
legend("bottomleft",legend=c(cn[-1]), fill="white", lty=c(1,2), lwd=2, col = c("blue", "dark green", "black"))


#Compare brier scores
bs_mod1 <- mean((pred_mod1 - ICUMort.f$in_hospital_death)^2)
cat("Model 1 Brier score - ",bs_mod1)
bs_mod2 <- mean((pred_mod2 - ICUMort.f$in_hospital_death)^2)
cat("Model 1 Brier score - ",bs_mod2)
bs_mod3 <- mean((pred_mod3 - ICUMort.f$in_hospital_death)^2)
cat("Model 1 Brier score - ",bs_mod3)
bs_null <- mean((pred_null - ICUMort.f$in_hospital_death)^2)
cat("Model 1 Brier score - ",bs_null)
#Almost the same with the exception of the null.  Lower score is better, so models 2 and 3 are the best by this metric.

#PseudoR2
library(DescTools)
#PsuedoR2 models under question
a <- t(PseudoR2(f.mod1, which = c("AldrichNelson", "Effron", "AIC")))
b <- t(PseudoR2(f.mod2, which = c("AldrichNelson", "Effron", "AIC")))
c <- t(PseudoR2(f.mod3, which = c("AldrichNelson", "Effron", "AIC")))
d <- t(PseudoR2(null_mod, which = c("AldrichNelson", "Effron", "AIC")))

#turn into table for easier interpretation
psudortbl_1 <- rbind(a,b,c,d)
rownames(psudortbl_1) <- c("f.mod1", "f.mod2", "f.mod3", "null_mod")
#round values for output
round(psudortbl_1,4)
```

## Goodness of fit
Based on the Hoslem test, Brier score and pseudoR2 values, models 1 (multivariable only model) and 3 (model with variables + interactions) perform the best. While model 2 has a better Brier score and AIC than model 1, it is statistically significant for poor fit on the Hoslem test. Model 3 out performs model 1 in all tests - model 3 is the best model.

```{r AUROC for models 2 and 3}
library(pROC)
#Create a SAPS 1 only model for comparison
SAPS.mod <- glm(in_hospital_death ~ SAPS1, data = ICUMort.f, family = binomial)
predSAPS <- predict(SAPS.mod, type="response")
#Vector of outcomes
oc <- ICUMort.f$in_hospital_death
par(pty="s")
#Overlay ROC curves for models 1, 2 and 3 and compare to SAPS
plot.roc(oc, pred_mod1, auc.polygon = TRUE, 
         auc.polygon.col=rgb(.9,0.1,0.1, alpha = 0.3), col="red",
         legacy.axes = TRUE)
plot.roc(oc, pred_mod3, auc.polygon = TRUE, 
         auc.polygon.col=rgb(.1,0.9,0.1, alpha = 0.3), add=TRUE,col="green",
         legacy.axes = TRUE)
plot.roc(oc, predSAPS, auc.polygon = TRUE, 
         auc.polygon.col=rgb(0.1,1,1, alpha = 0.3), col="black",add=TRUE,
         legacy.axes = TRUE)

legend("bottomright",
       legend=c("Multivariable - Model 1", "Multivariable Interation - Model 3", "SAPS Only Model"),
       title="Models:", 
       fill=c(rgb(.9,0.1,0.1, alpha = 0.3),
              rgb(.1,0.9,0.1, alpha = 0.3),
              #rgb(1,1,0.1, alpha = 0.3),
              rgb(0.1,1,1, alpha = 0.3)), 
       inset=c(0.1,0.1))

#Confusion matrix to evaluate performance
library(caret)
#Create vectors of predicted outcomes, set 0.5 as threshold
pred_oc_mod1 <- as.factor(ifelse(pred_mod1 < 0.5, "no", "yes"))
pred_oc_mod2 <- as.factor(ifelse(pred_mod2 < 0.5, "no", "yes"))
pred_oc_mod3 <- as.factor(ifelse(pred_mod3 < 0.5, "no", "yes"))
#Actual outcome as a factor
ocf <- as.factor(ifelse(ICUMort.f$in_hospital_death == 0, "no", "yes"))
(mod1_cm<-confusionMatrix(pred_oc_mod1, ocf, positive = "yes"))
(mod2_cm<-confusionMatrix(pred_oc_mod2, ocf, positive = "yes"))
(mod3_cm<-confusionMatrix(pred_oc_mod3, ocf, positive = "yes"))
```
## Best performing models
The multivariable model with no interactions (model 1) performs the worst with the smallest AUC, and lowest sensitivity and positive predictive value.  Model 3 (multivariable plus interactions) performs noticably better than Model 1. Both models perform better than a model based on SAPS1 alone, a previously developed predictor of mortality in hospital.

There appears to be a strong difference between the physiological variables and what type of ICU they are in. This seems logical. Attempt creating a different model for individual ICUs and combining at the end for prediction outcome.

```{r multimodel method for each ICU type, include = FALSE}
#review analysis of ICUType specific models, create data frames
ICUMort.CCU <- ICUMort.f[ICUMort.f$ICUType=="Coronary Care Unit",]
ICUMort.CCU <- within(ICUMort.CCU, rm(ICUType))
ICUMort.MICU <- ICUMort.f[ICUMort.f$ICUType=="Medical ICU",]
ICUMort.MICU <- within(ICUMort.MICU, rm(ICUType))
ICUMort.SICU <- ICUMort.f[ICUMort.f$ICUType=="Surgical ICU",]
ICUMort.SICU <- within(ICUMort.SICU, rm(ICUType))
ICUMort.CSRU <- ICUMort.f[ICUMort.f$ICUType=="Cardiac Surgery Recovery Unit",]
ICUMort.CSRU <- within(ICUMort.CSRU, rm(ICUType))


#Should start with univariate models for each of the variables we included.
#Create vector of variables
var_selection <- c("Age", "GCS_max", "SAPS1", "HR_min", "ALP_max", "PaO2_max", "Urine_max", "BUN_min", "WBC_max", "Lactate_diff", "Gender")
#Create a list of univariate models for each of the variables selected
formulas<- paste('in_hospital_death ~', var_selection)
unimod.list.CCU <- lapply(formulas, glm, family = binomial(), data = ICUMort.CCU)
unimod.list.MICU <- lapply(formulas, glm, family = binomial(), data = ICUMort.MICU)
unimod.list.SICU <- lapply(formulas, glm, family = binomial(), data = ICUMort.SICU)
unimod.list.CRSU <- lapply(formulas, glm, family = binomial(), data = ICUMort.CSRU)

#Summary of all models
(unimod_summ.CCU <- lapply(unimod.list.CCU, summary))
(unimod_summ.MICU <- lapply(unimod.list.MICU, summary))
(unimod_summ.SICU <- lapply(unimod.list.SICU, summary))
(unimod_summ.CRSU <- lapply(unimod.list.CRSU, summary))


#full models using most statistically significant output from each univariable group with added interaction between age and gender
CCU.full.mod <- glm(in_hospital_death ~ Age + GCS_max + SAPS1 + ALP_max + Urine_max + BUN_min + WBC_max + Lactate_diff +
                      Age:Gender, data=ICUMort.CCU, family="binomial")
(sum.full.CCU <- summary(CCU.full.mod))
#significant predictors at 0.1 - BUN_max, GCS_max, SAPS1

MICU.full.mod <- glm(in_hospital_death ~ Age + GCS_max + SAPS1 + HR_min + ALP_max + Urine_max +
                       BUN_min + Lactate_diff + Gender + Age:Gender, data=ICUMort.MICU, family="binomial")
(sum.full.MICU <- summary(MICU.full.mod))
#significant predictors at 0.1 - Age, BUN_min, Na_max, Platelets_dif, WBC_max, SAPS1

SICU.full.mod <- glm(in_hospital_death ~ Age + GCS_max + SAPS1 + HR_min + Urine_max +
                       BUN_min + Lactate_diff + Gender + Age:Gender, data=ICUMort.SICU, family="binomial")
(sum.full.SICU <- summary(SICU.full.mod))
#significant predictors at 0.05 - Age, BUN_min,GCS_max, Gender, pH_diff, RespRate_min, TroponinI_diff, WBC_min, SAPS1

CSRU.full.mod <- glm(in_hospital_death ~ GCS_max + PaO2_max + Urine_max + BUN_min + Lactate_diff +
                       Age:Gender, data=ICUMort.CSRU, family="binomial")
(sum.full.CSRU <- summary(CSRU.full.mod))
#significant predictors at 0.05 - BUN_min, GCS_max, Na_diff, PaO2_max, pH_max, Platelets_max, WBC_min

#significan models - keeping Age:Gender as a predictor
#CCU
CCU.sig.mod <- glm(in_hospital_death ~ BUN_min + GCS_max + SAPS1 + Age:Gender, data=ICUMort.CCU, family="binomial")
(sum.sig.CCU <- summary(CCU.sig.mod))
anova(CCU.full.mod, CCU.sig.mod, test="Chisq")
CCU.full.mod$aic
CCU.sig.mod$aic
#not statistically different, AIC much better for simpler model
CCU.red.mod <- step(CCU.full.mod, trace=0)
#AIC stepwise reduced model included many 
(sum.red.CCU <- summary(CCU.red.mod))
anova(CCU.full.mod, CCU.red.mod, test="Chisq")
CCU.full.mod$aic
CCU.red.mod$aic
#significant and reduced models quite different as Age:Gender interaction not kept in stepwise model. Unable to improve AIC without removing, neither are statistically different from the full model, AICs similar (dif <4)
#compare brier scores
mean((predict(CCU.sig.mod, type = "response") - ICUMort.CCU$in_hospital_death)^2)
mean((predict(CCU.red.mod, type = "response") - ICUMort.CCU$in_hospital_death)^2)

#slightly better fit for significant model on brier score (0.101 vs 0.102) - keep
CCU.mod <- CCU.sig.mod

#MICU
MICU.sig.mod <- glm(in_hospital_death ~ SAPS1 + HR_min + ALP_max + BUN_min + Lactate_diff + Age:Gender
                    , data=ICUMort.MICU, family="binomial")
(sum.sig.MICU <- summary(MICU.sig.mod))
anova(MICU.full.mod, MICU.sig.mod, test="Chisq")
MICU.full.mod$aic
MICU.sig.mod$aic
#statistically significant difference, resid dev better in full model, AIC marginal. check stepwise reduction.
MICU.red.mod <- step(MICU.full.mod, trace=0)
anova(MICU.full.mod, MICU.red.mod, test="Chisq")
MICU.full.mod$aic
MICU.red.mod$aic
#not statistically different, AICs the same between red and sig. check brier score
mean((predict(MICU.sig.mod, type = "response") - ICUMort.MICU$in_hospital_death)^2)
mean((predict(MICU.red.mod, type = "response") - ICUMort.MICU$in_hospital_death)^2)
#reduced model slightly better, keep
MICU.mod <- MICU.red.mod

#SICU
SICU.sig.mod <- glm(in_hospital_death ~ Age + BUN_min + GCS_max + SAPS1 + Age:Gender, data=ICUMort.SICU, family="binomial")
(sum.sig.SICU <- summary(SICU.sig.mod))
anova(SICU.full.mod, SICU.sig.mod, test="Chisq")
SICU.full.mod$aic
SICU.sig.mod$aic
#no statistically significant difference, AIC slightly better for sig model. check stepwise reduction.
SICU.red.mod <- step(SICU.full.mod, trace=0)
anova(SICU.full.mod, SICU.red.mod, test="Chisq")
SICU.full.mod$aic
SICU.red.mod$aic
#not statistically different, AIC slightly improved in reduced model. Age and Gender in reduced model without interaction
#compare brier scores
mean((predict(SICU.sig.mod, type = "response") - ICUMort.SICU$in_hospital_death)^2)
mean((predict(SICU.red.mod, type = "response") - ICUMort.SICU$in_hospital_death)^2)
#marginally better for sig model
SICU.mod <- SICU.sig.mod


CSRU.sig.mod <- glm(in_hospital_death ~ BUN_min + GCS_max + PaO2_max + Age:Gender
                       , data=ICUMort.CSRU, family="binomial")
(sum.sig.CSRU <- summary(CSRU.sig.mod))
anova(CSRU.full.mod, CSRU.sig.mod, test="Chisq")
CSRU.full.mod$aic
CSRU.sig.mod$aic
#not statistically different, AIC worse in sig model.
CSRU.red.mod <- step(CSRU.full.mod, trace=0)
anova(CSRU.full.mod, CSRU.red.mod, test="Chisq")
CSRU.full.mod$aic
CSRU.red.mod$aic
#not statistically different, AIC slighly improved in reduced model.
#compare brier scores between full and reduced
mean((predict(CSRU.full.mod, type = "response") - ICUMort.CSRU$in_hospital_death)^2)
mean((predict(CSRU.red.mod, type = "response") - ICUMort.CSRU$in_hospital_death)^2)
#Marginal Keep full model.
CSRU.mod <- CSRU.full.mod
```

## Rational for multi unit model
Logical to assume different unit have different patient characteristics. In the interests of keeping things simple we have used the same variables that were identified for the previous models then customised them to each unit. 

```{r check fit for mutli unit model}

#check goodness of fit
#Calculate the Hosmer-Lemeshow statistic
#linear predictors

#Vector of predicted probabilities
pred.CCU <- predict(CCU.mod, type = "response")
(hl_CCU <- hoslem.test(CCU.mod$y, pred.CCU, g=30))
#No indication of a lack of fit as p > 0.05.

pred.MICU <- predict(MICU.mod, type = "response")
(hl.MICU <- hoslem.test(MICU.mod$y, pred.MICU, g=30))
#No indication of a lack of fit as p > 0.05.

pred.SICU <- predict(SICU.mod, type = "response")
(hl.SICU <- hoslem.test(SICU.mod$y, pred.SICU, g=30))
#No indication of a lack of fit as p > 0.05.

pred.CSRU <- predict(CSRU.mod, type = "response")
(hl.CSRU <- hoslem.test(CSRU.mod$y, pred.CSRU, g=40))

#No indication of a lack of fit as p > 0.05.


null.CCU.mod <- glm(in_hospital_death ~ 1, data = ICUMort.CCU, family = binomial)
null.MICU.mod <- glm(in_hospital_death ~ 1, data = ICUMort.MICU, family = binomial)
null.SICU.mod <- glm(in_hospital_death ~ 1, data = ICUMort.SICU, family = binomial)
null.CSRU.mod <- glm(in_hospital_death ~ 1, data = ICUMort.CSRU, family = binomial)

null.CCU <- predict(null.CCU.mod, type = "response")
null.MICU <- predict(null.MICU.mod, type = "response")
null.SICU <- predict(null.SICU.mod, type = "response")
null.CSRU <- predict(null.CSRU.mod, type = "response")

#Compare brier scores
(bs.CCU <- mean((pred.CCU - ICUMort.CCU$in_hospital_death)^2))
mean((null.CCU - ICUMort.CCU$in_hospital_death)^2)

(bs.MICU <- mean((pred.MICU - ICUMort.MICU$in_hospital_death)^2))
mean((null.MICU - ICUMort.MICU$in_hospital_death)^2)

(bs.SICU <- mean((pred.SICU - ICUMort.SICU$in_hospital_death)^2))
mean((null.SICU - ICUMort.SICU$in_hospital_death)^2)

(bs.CSRU <- mean((pred.CSRU - ICUMort.CSRU$in_hospital_death)^2))
mean((null.CSRU - ICUMort.CSRU$in_hospital_death)^2)

#brier scores better than null models

#Brier score indicates that the reduced and full models are better than the null, but nor by a huge degree.
#PseudoR2

#PsuedoR2 models under question
a <- t(PseudoR2(CCU.mod, which = c("AldrichNelson", "Effron", "AIC")))
b <- t(PseudoR2(MICU.mod, which = c("AldrichNelson", "Effron", "AIC")))
c <- t(PseudoR2(SICU.mod, which = c("AldrichNelson", "Effron", "AIC")))
d <- t(PseudoR2(CSRU.mod, which = c("AldrichNelson", "Effron", "AIC")))
e <- t(PseudoR2(null_mod, which = c("AldrichNelson", "Effron", "AIC")))

#turn into table for easier interpretation
psudortbl_2 <- rbind(a,b,c,d,e)
rownames(psudortbl_2) <- c("CCU.mod", "MICU.mod", "SICU.mod", "CSRU.mod","null_mod")
#round values for output
round(psudortbl_2,4)
#compare to models for all ICU units
round(psudortbl_1,4)
#Seperate models per ICU give better psuedo R2 values.

#create column for predicted probability
ICUMort.f$predprob <- 0

#populate probability for individual unit types across whole data set
ICUMort.f[ICUMort.f$ICUType=="Coronary Care Unit",] %>% mutate(predprob=predict(CCU.mod, type="response")) -> ICUMort.f[ICUMort.f$ICUType=="Coronary Care Unit",]
ICUMort.f[ICUMort.f$ICUType=="Medical ICU",] %>% mutate(predprob=predict(MICU.mod, type="response")) -> ICUMort.f[ICUMort.f$ICUType=="Medical ICU",]
ICUMort.f[ICUMort.f$ICUType=="Surgical ICU",] %>% mutate(predprob=predict(SICU.mod, type="response")) -> ICUMort.f[ICUMort.f$ICUType=="Surgical ICU",]
ICUMort.f[ICUMort.f$ICUType=="Cardiac Surgery Recovery Unit",] %>% mutate(predprob=predict(CSRU.mod, type="response")) -> ICUMort.f[ICUMort.f$ICUType=="Cardiac Surgery Recovery Unit",]

#brier score for overall model
mean((ICUMort.f$predprob - ICUMort.f$in_hospital_death)^2)
mean((pred_null - ICUMort.f$in_hospital_death)^2)

```
Difficult to compare fit due to differences in dataset sizes. Compare AUROC.

```{r multi unit analysis prediction}
#plot ROC for multi unit model
par(pty="s")
plot.roc(oc, ICUMort.f$predprob,auc.polygon = TRUE,
         auc.polygon.col=rgb(1,0.1,0.1, alpha = 0.3), col = "yellow",
         legacy.axes = TRUE, print.auc = TRUE, 
         print.auc.y = 0.2, print.auc.col = "orange")

#Compare to best model for all ICU units
plot.roc(oc, pred_mod3, auc.polygon = TRUE, 
         auc.polygon.col=rgb(.1,0.9,0.1, alpha = 0.3),add=TRUE, col="green",
         legacy.axes = TRUE, print.auc = TRUE, print.auc.x = 0.4, 
         print.auc.y = 0.3)

legend("bottomleft",
       legend=c("Split ICU model", "Multivariable Interation Model"),
       title="Models:", 
       fill=c(rgb(1,0.1,0.1, alpha = 0.3),rgb(.1,0.9,0.1, alpha = 0.3)), 
       inset=c(0.1,0.1))
```
Models are virtually the same on AUROC. Shows that interaction model adequately accounts for differences between ICUs.

## Refit final model (model 3)


```{r refit}

#refit previous models  to icu_patients_df0


df0.f <- icu_patients_df0[,c("Age", "GCS_max", "SAPS1", "HR_min", "ALP_max", "PaO2_max", "Urine_max", "BUN_min", "ICUType", "Lactate_diff", "Gender", "in_hospital_death")]
df0.f <- df0.f[complete.cases(df0.f),]
summary(df0.f)

summary(df0.f)
val.mod3 <- glm(in_hospital_death ~ SAPS1 + Age + BUN_min + GCS_max + 
                ALP_max + ICUType + PaO2_max + Urine_max + Lactate_diff + 
                GCS_max:HR_min + Age:ICUType + GCS_max:ICUType + SAPS1:ICUType + 
                BUN_min:ICUType + ICUType:Gender, family = binomial(), data = df0.f)


#plot ROC for multi unit model
#Compare to best model for all ICU units
plot.roc(df0.f$in_hospital_death, predict(val.mod3, type="response"), auc.polygon = TRUE, 
         auc.polygon.col=rgb(.9,0.1,0.1, alpha = 0.3), col="red",
         legacy.axes = TRUE, print.auc = TRUE, print.auc.x = 0.4, 
         print.auc.y = 0.3)

```

```{r confusion matrix for best performing models}
#Calculate confusion matrix for validation
ocf.val <- as.factor(ifelse(df0.f$in_hospital_death == 0, "no", "yes"))
pred_oc_ICUval <- as.factor(ifelse(predict(val.mod3, type = "response") < 0.5, "no", "yes"))
(ICUmods_cm <-confusionMatrix(pred_oc_ICUval, ocf.val, positive = "yes"))

ocf.orig <- as.factor(ifelse(ICUMort.f$in_hospital_death == 0, "no", "yes"))
pred_oc_ICUorig <- as.factor(ifelse(predict(f.mod3, type = "response") < 0.5, "no", "yes"))
(ICUmods_cm <-confusionMatrix(pred_oc_ICUorig, ocf.orig, positive = "yes"))


#The models seperated by ICU perform better than the single model, but it is a marginal increase.  In practice this maybe hard to implement, as different models would be required for different units.  

```

In general, for all the models tested the sensitivity was relatively low, and the positive predictive value somewhere between 50-60%.  This means that only ~20% of people that die would be identified as at high risk, and of the people identified as at high risk, about half of them are incorrectly classified.  Despite this, a single model (i.e. model 3) would still be useful if the aim was to predict which patients may be at higher risk of death and allocate resources accordingly.  In model 3 (multivariable + interactions), ICUType had the highest affect on risk of death in the model with risk of death increased by 600%!

The performance of the fitted model between the orginal data and the unimputed data was not too different. A major difficulty in accurately assessing this is the amount of data lost when using the model to assess the outcome.  
  
  

# Task 2 (15 marks)

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately explains or predicts the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a series of models, maybe three or four, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. Aim for between five and ten predictor variables (slightly more or fewer is OK). It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at comment on the possible impact of what your diagnostics show). Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.


### Hints

1. Select an initial subset of explanatory variables that you will use to predict survival. Justify your choice.

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate Cox proportional hazards models.

4. Fit an appropriate series of multivariable Cox proportional hazards models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them. 

7. Write a very brief paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation. 

####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 

```{r data-setup}
library(survival)
library(rankhazard)
library(survminer)
library(eha)

```

### Task 2 Part 1
### Variable selection

As discussed prevously, the variable SOFA appears to be unreliable - so we will not use this in our analysis. 
We will include the SAPS1 score, since it includes information from a range of the variables, reducing the need to include them in our model. 

The SAPS score is based on the following variables - Age, HR, SBP, Temp, RR, urine, BUN, HCT, WBC, glucose, potassium, sodium, HCO3, GCS. It looks at max/min values rather than any changes in measurements, i.e. the "_diff" variables may have some extra useful information.

We will include Age, Gender and ICUType since these are important demographic characteristics.

We will include Na_diff, K_diff and pH_diff - since large changes in these variables may be a sign of poor prognosis. Lactate_max, HCO3_min, PaO2_min, BUN_max are also markers of poor prognosis. 

We will include TroponinI_max, since it is a marker of cardiac tissue damage. Cholesterol_max may be a longer term factor - include it in initial analysis. Also include WBC_min and Platelets_min as low counts may be a relevant marker. 

Initial subset of 15 variables:
"SAPS1", "Age", "Gender", "ICUType", "Na_diff", "K_diff", "pH_diff", "Lactate_max", "HCO3_min", "PaO2_min", "BUN_max", "TroponinI_max", "Cholesterol_max", "WBC_min", "Platelets_min"


```{r Task2_Part1a}

# Create list of required variables
var.list2 <- c("SAPS1", "Age", "Gender", "ICUType", "Na_diff", "K_diff", "pH_diff", "Lactate_max", "HCO3_min", "PaO2_min", "BUN_max", "TroponinI_max", "Cholesterol_max", "WBC_min", "Platelets_min")

# Create dataframe with the required variables, eliminating any observations with NA's
ICUSurv <- icu_patients_df1[, c("in_hospital_death", "Days", "Status", var.list2)]
ICUSurv <- ICUSurv[complete.cases(ICUSurv),]

str(ICUSurv)
```


### Task 2 Part 2
### EDA
```{r Task2_Part2a}

summary(ICUSurv)


#density plots for reviewing variables based on outcome
#Create empty list to store plots
plot_list2 <- list()
for (i in names(ICUSurv)[4:18]){
  
  if(is.numeric(ICUSurv[[i]])){
  
    plot_list[[i]] <- ggplot(ICUSurv, aes_string(i)) +
          geom_histogram(aes(y = ..density.., fill = factor(in_hospital_death, labels = c("No","Yes"))), alpha = .3, bins = 60, position = "identity") +
          labs(x=i, fill="Died", title = paste0("Density Plot of ", i,", ", length(na.omit(ICUSurv[[i]]))," values available")) + 
      theme(text = element_text(size=6))

    }else{

    plot_list[[i]] <- ggplot(ICUSurv, aes_string(i)) +
          geom_bar(position = "fill", aes(fill=factor(in_hospital_death, labels = c("No", "Yes")))) +
          labs(x = i, fill = "Died", title = paste0("Bar Plot of ", i,", ",  length(na.omit(ICUSurv[[i]])), " values available")) +
      theme(text = element_text(size=6))
 
  }
}


n <- length(plot_list)
nCol <- 4
do.call("grid.arrange", c(plot_list, ncol=nCol))

```


Kaplan-Meier and Nelson-Aalen curves for our data are plotted below.

```{r Task2_Part2b}

# Plot the overall Kaplan-Meier survival curve for the data
hd_fit <- survfit( Surv(Days,Status) ~ 1, data = ICUSurv) 

# plotting Kaplan-Meier estimate
plot(hd_fit, main = 'Kaplan-Meier estimate of survival function', xlab = 'Days')


# get the mean and median survival times
print(hd_fit, print.rmean = TRUE)
# plot the median survival time
plot(hd_fit, main = 'Kaplan-Meier estimate of survival function', xlab = 'Days')
abline(a = 0.5, b = 0)

# plotting Nelson-Aalen estimate
plot(hd_fit, fun="cumhaz", main = "Nelson-Aalen estimate of cumulative hazard function", xlab = "Days")





```


```{r Task2_Part2c}
par(mfrow=c(1,2))
# plot the Kaplan-Meier survival curves by the categorical variables
hd_fitbyGender <- survfit( Surv(Days,Status) ~ Gender, data = ICUSurv) 
plot(hd_fitbyGender, main = 'Kaplan-Meier estimate of survival function', xlab = 'Gender',col = c("red","blue"))

hd_fitbytype <- survfit( Surv(Days,Status) ~ ICUType, data = ICUSurv) 
plot(hd_fitbytype, main = 'Kaplan-Meier estimate of survival function', xlab = 'ICU Type',col = c("red","blue","orange","black"))
par(mfrow=c(1,1))
```



### Task 2 Part 3
```{r Task2_Part3}

#making formulas
univ_formulas <- sapply(var.list2, function(x)as.formula(paste('Surv(Days,Status)~',x))
)
#making a list of models
univ_models <- lapply(univ_formulas, function(x){coxph(x,data=ICUSurv)})

univ_results <- lapply(univ_models, function(x){summary(x)})
univ_results
```

The non-significant variables are TroponinI_min, WBC_min and Platelets_min.
We will not include these in the model.
We also see that Gender is not significant, however we will leave this in due for now since it is often an important confounder.



### Task 2 Part 4

First we will fit a multivariate model with all our variables:
"SAPS1", "Age", "Gender", "ICUType", "Na_diff", "K_diff", "pH_diff", "Lactate_max", "HCO3_min", "PaO2_min", "BUN_max", "Cholesterol_max"
```{r Task2_Part4a}

multivar.list2 <- c("SAPS1", "Age", "Gender", "ICUType", "Na_diff", "K_diff", "pH_diff", "Lactate_max", "HCO3_min", "PaO2_min", "BUN_max", "Cholesterol_max")


# fit multivariable Cox proportional hazards models with significant univariate Cox proportional hazards models 
cox.mv1 <- coxph(Surv(Days, Status) ~ SAPS1 + Age + Gender + ICUType + Na_diff + K_diff + pH_diff + Lactate_max + HCO3_min + PaO2_min + BUN_max + Cholesterol_max, data = ICUSurv)
summary(cox.mv1)

```

The variables Gender, Na_diff, K_diff, PaO2_min and Cholesterol_max are not significant. 
Fit a new model with these removed. 

```{r Task2_Part4b}

cox.mv2 <- coxph(Surv(Days, Status) ~ SAPS1 + Age + ICUType + pH_diff + Lactate_max + HCO3_min + BUN_max, data = ICUSurv)
summary(cox.mv2)

```


We can also use the step function to try find a simpler model. The step function continually applies a drop function for us. 
```{r Task2_Part4c}

cox.mv3 <- step(cox.mv1, test="Chisq")
summary(cox.mv3)


```
_Note that this model uses the same variables as cox.mv2, but includes Cholesterol_max as well. Notice that the AICs are the same if you include or exclude the Cholesterol_max._

Perform anova on the models to see if there are any significant differences.
```{r}
#Perform anova on the models

print(anova(cox.mv1, cox.mv2))
print(anova(cox.mv1, cox.mv3))
print(anova(cox.mv3, cox.mv2))


# Also display AICs for each of the models
extractAIC(cox.mv1)
extractAIC(cox.mv2)
extractAIC(cox.mv3)
```
_Using ANOVA - we can see that there is no significant difference between the full model and either of the simpler models. Also there is no difference between the two simple models, and as such we can exclude the Cholesterol_max variable and just use the simplest model (cox.mv2)._
_Note, by printing the AICs, we see that in fact that the model with cholesterol has a very slightly lower AIC. Given how close this is, we will just stick with the simplest model._



### Task 2 Part 5
```{r Taks2_Part5}
# Present the final model:

summary(cox.mv2)
survminer::ggforest(cox.mv2, data=ICUSurv)
# plot the Kaplan-Meier survival curve

fit.mv2 <- survfit(cox.mv2, data = ICUSurv)
plot(fit.mv2, main = "Kaplan-Meier estimate of survival function", xlab = "Days")
#plot(fit.mv2, fun="cumhaz", main = "Nelson-Aalen estimate of cumulative hazard function", xlab = "Days")

```

We can also fit to the unseen data
```{r Taks2_Part5b}

# Re-fit to the unseen data

cox.new <- coxph(Surv(Days, Status) ~ SAPS1 + Age + ICUType + pH_diff + Lactate_max + HCO3_min + BUN_max, data = icu_patients_df1)
summary(cox.new)
extractAIC(cox.new)

```
We can see that this model fits quite well to the unseen data. All the covariates are still significant and the overall model is also significant. 

### Task 2 Part 6

Diagnostic statistics. 
Assess the proportional hazards assumption and linearity assumptions.
```{r Task2_Part6.a}
# Diagnostic statistics:

# Assessing the proportional hazards assumption:
# testing for proportional hazards assumption using cox.zph()
prop.mv2 <- cox.zph(cox.mv2)
prop.mv2
# scaled Schoenfeld residuals against the transformed time
ggcoxzph(prop.mv2)

# Assessing linearity: assume that continuous covariates have a linear form
# plot the Martingale residuals against continuous covariates can be used to detect nonlinearity 
# graphs of continuous covariates against martingale residuals of null cox proportional hazards model
ggcoxfunctional(Surv(Days, Status) ~ SAPS1 + Age + pH_diff + Lactate_max + HCO3_min + BUN_max, data = ICUSurv, iter = 5)

```

A significant P value indicates that the proportional hazards assumption is violated for that covariate.
The output from the proportional hazards test shows that the test is statistically significant for SAPS1, ICUType, Lactate_max and HCO3_min (but not for any other covariates). The global test is also statistically significant (p-value = 4.95e-10). Therefore, there appears to be a violation of the proportional hazards model.

We also see there is a linearity issue particularly with the HCO3_min. SAPS1 and Age are very linear, and we can see some linearity for pH_diff, Lactate_max and BUN_max. This non-linearity is probably because both low and high values of HCO3 may have an effect on survival. 

To resolve this, we will add covariate x time interaction to resolve violations of the proportional hazards assumption
From the plots, we can see a potential time cut at around 41 days. We will choose 42 days, since it is the answer to the meaning of life, the universe, and everything. 

We will also try a model without the HCO3 covariate.
```{r Task2_Part6b}

# splitting the old dataset to two time intervals at 42 days
icu.split <- survSplit( Surv(Days, Status) ~ ., data = ICUSurv, cut=c(42), episode= "tgroup")
# fitting Cox multivariable model to the new dataset
cox.mv4 <- coxph( Surv(Days, Status) ~ SAPS1:strata(tgroup) + Age + ICUType:strata(tgroup) + pH_diff + Lactate_max:strata(tgroup) + HCO3_min:strata(tgroup) + BUN_max, data = icu.split) 
summary(cox.mv4)

# evaluating the proportional hazards assumption
prop.mv4 <- cox.zph(cox.mv4)
prop.mv4
ggcoxzph(prop.mv4)

cox.mv5 <- coxph( Surv(Days, Status) ~ SAPS1:strata(tgroup) + Age + ICUType:strata(tgroup) + pH_diff + Lactate_max:strata(tgroup) + BUN_max, data = icu.split) 
summary(cox.mv5)

extractAIC(cox.mv2)
extractAIC(cox.mv4)
extractAIC(cox.mv5)

print(anova(cox.mv4, cox.mv5))



```
_Using this new stratified model (cox.mv4), the individual covariates no longer violate the proportional hazards assumption. Similarly the global test is no longer significant (p=0.9562) and thus the assumption holds for our new model._

_Also we can see that this model has a lower AIC (10462.16 vs 10496.25), meaning that it is likely a better model in general. _

_However, this model is also a lot more difficult to interpret, and so whether we use it or not partially depends on whether we are aiming purely for prediction, or whether we care about interpretability._

_Note - We see that the model without HCO3 (cox.mv5) is significantly different and has a higher AIC than cox.mv4, so we will not use that one. _



This our second final model is:
```{r Task2_final model}

summary(cox.mv4)


```

Further diagnostics for both models:
```{r Taks2_Part6.d}
# Testing influential observations:
# plots the estimated changes in the regression coefficients upon deleting each observation in turn
ggcoxdiagnostics(cox.mv2, type = "dfbeta",
                 linear.predictions = FALSE, 
                 ggtheme = theme_bw())

# check outliers by visualizing the deviance residuals
# deviance residual is a normalized transform of the martingale residual
# residuals should be roughtly symmetrically distributed about zero with a standard deviation of 1.
ggcoxdiagnostics(cox.mv2, type = "deviance",
                 linear.predictions = FALSE, 
                 ggtheme = theme_bw())

# Positive values correspond to individuals that “died too soon” compared to expected survival times.
# Negative values correspond to individual that “lived too long”.


ggcoxdiagnostics(cox.mv4, type = "dfbeta",
                 linear.predictions = FALSE, 
                 ggtheme = theme_bw())

# check outliers by visualizing the deviance residuals
# deviance residual is a normalized transform of the martingale residual
# residuals should be roughtly symmetrically distributed about zero with a standard deviation of 1.
ggcoxdiagnostics(cox.mv4, type = "deviance",
                 linear.predictions = FALSE, 
                 ggtheme = theme_bw())

```


### Task 2 Part7

In regards to the model that includes a covariate x time interaction:

The p-value (<2e-16) for all three overall tests (likelihood ratio test, Wald test, and score test) are significant, indicating that the model is significant.

The hazard ratios for Age and BUN_max are greater than 1 and statistically significant, meaning that increases in Age and BUN are associated with higher risk of death. Similarly, a higher SAPS1 has a higher risk of death (lower survival time), and this is true for both time strata. BUN_max is borderline significant, and has a >1 hazard ratio. We also see that being in the ICU Type - Cardiac Surgery Recovery Unit has a signficantly reduced risk of death (longer survival). This is true for both time strata. 

The reason a time interaction is needed is probably because the covariates being measured are good at predicting short term survival in the ICU. Patients who survive the initial acute period might have a completely different set of risk factors for survival. 

If we do not use the time interaction, the model is still significant - p-value <2e-16 for all three overall tests (likelihood ratio test, Wald test, and score test). ICU Type of Cardiac Surgery Recovery Unit has a statistically significant hazard ratio 0.38 (longer survival). The other ICU Types do not have significant differences. The other covariates SAPS1, Age, pH_diff, Lactate_max, HCO3_min and BUN_max all have significant hazard ratios >1 (shorter survival). An example of interpreting these values - SAPS1 has a significant hazard ratio of 1.06, which means for every unit increase in the SAPS score, there is a 1.06 higher risk of death at any point in time. However, since the proportional hazards assumptions do not quite hold, we cannot be sure that this hazard ratio of 1.06 is the same for every time point - it just gives us an average over the entire time span. 

The time interaction is useful here. In the covariate x time model, using the SAPS1 score as an example, before 42 days, there is a hazard ratio of 1.079 compared to a hazard ratio of 1.046 after 42 days. 





## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works, and then submit via the drop box in Openlearning.

## Submit your assignment

When you have finished, and are satisfied with your assignment solutions, and this file knits without errors and the output looks the way you want, then you should submit via the drop box in Openlearning.

### Problems?

If you encounter problems with any part of the process described above, please contact the course instructor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assignment is due.


### Additional Information

Each task attracts the indicated number of marks (out of a total of 30 marks for the assignment). The instructions are deliberately open-ended and less prescriptive than the individual assignments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks and gain full marks, you only need to replicate or repeat the steps covered in the course - if you do most or all of the things described in the revalant chapters of the HDAT9600 course, full marks wil be awarded. 

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course instructor.
